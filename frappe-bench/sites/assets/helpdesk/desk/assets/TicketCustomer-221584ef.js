import{d as E,P as K,u as Q,a2 as z,N as y,E as B,W as X,o,i as h,f as n,g as d,T as N,h as e,w as g,q as T,a1 as q,e as k,S as R,a9 as M,_ as U,aa as J,J as Y,L as Z,F as D,r as H,a3 as W,ab as ee,U as te,ac as O,ad as se,a4 as ae,z as I,v as S,c as ne,ae as oe}from"./index-a86022ab.js";import{I as $}from"./iconify-6a43d462.js";import{u as L}from"./error-90c51c34.js";import{s as j,I as V,_ as le,a as ie}from"./TicketTextEditor.vue_vue_type_script_setup_true_lang-7bbd651c.js";import{d as C}from"./vuedraggable.umd-9334f31c.js";import{D as re}from"./Dropdown-068a4fad.js";import{_ as G}from"./UserAvatar.vue_vue_type_script_setup_true_lang-a7059022.js";import{_ as ce}from"./AttachmentItem.vue_vue_type_script_setup_true_lang-ae5a880a.js";import{_ as de}from"./StarRating.vue_vue_type_script_setup_true_lang-5c4d1ebd.js";import"./Breadcrumbs.vue_vue_type_script_setup_true_lang-3ebac268.js";import"./PageTitle.vue_vue_type_script_setup_true_lang-022e67c2.js";import"./FileUploader-c45cb8d3.js";import"./TextEditor-c90c58ca.js";import"./Avatar.vue_vue_type_script_setup_true_lang-f38fd5a3.js";import"./file-text-7a5c11aa.js";function ue(p){return{all:p=p||new Map,on:function(t,s){var l=p.get(t);l?l.push(s):p.set(t,[s])},off:function(t,s){var l=p.get(t);l&&(s?l.splice(l.indexOf(s)>>>0,1):p.set(t,[]))},emit:function(t,s){var l=p.get(t);l&&l.slice().map(function(a){a(s)}),(l=p.get("*"))&&l.slice().map(function(a){a(t,s)})}}}const A=ue(),me={class:"my-4 rounded border bg-cyan-50 p-4"},pe={class:"mb-4 flex items-center justify-between"},_e={class:"flex items-center gap-0.5 text-base"},fe={class:"text-gray-600"},ve={class:"flex items-center gap-1"},he=["innerHTML"],be=E({__name:"TicketComment",props:{content:{},date:{},isPinned:{},name:{},user:{}},setup(p){const t=p,{content:s,name:l,isPinned:a,user:m}=K(t),_=Q(),f=z($,{icon:"lucide:trash-2"}),i=z($,{icon:"lucide:pin"}),r=z($,{icon:"lucide:pin-off"}),u=y(()=>[{label:a.value?"Unpin":"Pin",icon:a.value?r:i,onClick:()=>c.submit()},{label:"Delete",icon:f,onClick:()=>F.submit(),isHidden:m.value.email!==_.userId}].filter(w=>!w.isHidden)),c=B({url:"frappe.client.set_value",makeParams:()=>({doctype:"HD Ticket Comment",name:l.value,fieldname:"is_pinned",value:!a.value}),onSuccess:()=>A.emit("update:ticket")}),F=B({url:"frappe.client.delete",makeParams:()=>({doctype:"HD Ticket Comment",name:l.value}),onSuccess(){A.emit("update:ticket"),X({title:"Comment deleted",icon:"check",iconClasses:"text-green-500"})}});return(w,b)=>(o(),h("div",me,[n("div",pe,[n("div",_e,[d(e(G),N(e(m),{size:"lg",expand:"",strong:""}),null,16),d(e($),{icon:"lucide:dot",class:"text-gray-500"}),d(e(q),{text:e(C)(w.date).long()},{default:g(()=>[n("div",fe,T(e(C).tz(w.date).fromNow()),1)]),_:1},8,["text"]),e(a)?(o(),k(e($),{key:0,icon:"lucide:dot",class:"text-gray-500"})):R("",!0),e(a)?(o(),k(e(M),{key:1,label:"Pinned",theme:"blue",variant:"outline"})):R("",!0)]),n("div",ve,[d(e(M),{label:"Comment",theme:"green",variant:"outline"}),d(e(re),{options:u.value},{default:g(()=>[d(e(U),{theme:"gray",variant:"ghost"},{icon:g(()=>[d(e($),{icon:"lucide:more-horizontal"})]),_:1})]),_:1},8,["options"])])]),n("span",{class:"prose-f",innerHTML:e(s)},null,8,he)]))}}),ge={class:"mx-3 pt-6"},ke={class:"mb-4 flex items-center justify-between text-base"},ye={class:"flex items-center gap-0.5"},xe={class:"text-gray-600"},$e=["innerHTML"],Ce={class:"flex flex-wrap gap-2"},we=E({__name:"TicketCommunication",props:{content:{},date:{},user:{},cc:{default:()=>""},bcc:{default:()=>""},attachments:{default:()=>[]}},setup(p){function t(s){return j(s,{allowedTags:j.defaults.allowedTags.concat(["img"])})}return(s,l)=>(o(),h("div",ge,[n("div",ke,[n("div",ye,[d(e(G),N(s.user,{size:"lg",expand:"",strong:""}),null,16),d(e($),{icon:"lucide:dot",class:"text-gray-500"}),d(e(q),{text:e(C)(s.date).long()},{default:g(()=>[n("div",xe,T(e(C).tz(s.date).fromNow()),1)]),_:1},8,["text"])]),J(s.$slots,"top-right",Y(Z({message:s.content})))]),n("span",{class:"prose-f",innerHTML:t(s.content)},null,8,$e),n("div",Ce,[(o(!0),h(D,null,H(s.attachments,a=>(o(),k(e(ce),{key:a.file_url,label:a.file_name,url:a.file_url},null,8,["label","url"]))),128))])]))}}),Te={class:"divide-y overflow-auto px-5 pb-32"},Se=["id"],Fe=E({__name:"TicketConversation",props:{focus:{default:""}},setup(p){const t=p,s=te(),l=O(V),a=y(()=>l.data||{}),m=y(()=>a.value.communications||[]),_=y(()=>a.value.comments||[]),f=y(()=>ae.orderBy([...m.value,..._.value],r=>C(r.creation)));function i(r){const u=document.getElementById(r);se(u).value||(u.scrollIntoView({behavior:"smooth"}),u.focus())}return W(()=>t.focus,r=>i(r)),ee(()=>{const u=s.hash.slice(1)||f.value.slice(-1).pop()?.name;u&&setTimeout(()=>i(u),1e3)}),(r,u)=>(o(),h("div",Te,[(o(!0),h(D,null,H(f.value,c=>(o(),h("div",{id:c.name,key:c.name,class:"mt-4"},[c.commented_by?(o(),k(be,{key:0,name:c.name,content:c.content,date:c.creation,user:c.user,"is-pinned":c.is_pinned},null,8,["name","content","date","user","is-pinned"])):(o(),k(we,{key:1,content:c.content,date:c.creation,user:c.user,"sender-image":c.sender,cc:c.cc||"",bcc:c.bcc||"",attachments:c.attachments},{"top-right":g(F=>[J(r.$slots,"communication-top-right",N({ref_for:!0},F))]),_:2},1032,["content","date","user","sender-image","cc","bcc","attachments"]))],8,Se))),128))]))}}),Pe={class:"grid grid-cols-1 gap-4 border-b px-5 py-2.5 sm:grid-cols-3"},Re={class:"space-y-1.5"},Be=n("span",{class:"block text-sm text-gray-700"}," Status ",-1),Ee={class:"block break-words text-base font-medium text-gray-900"},Ie={class:"space-y-1.5"},De=n("span",{class:"block text-sm text-gray-700"}," Priority ",-1),He={class:"block break-words text-base font-medium text-gray-900"},Ue={class:"block text-sm text-gray-700"},Ve={class:"block break-words text-base font-medium text-gray-900"},ze={key:1},Le={class:"block text-sm text-gray-700"},Ne={class:"block break-words text-base font-medium text-gray-900"},Oe=E({__name:"TicketCustomerTemplateFields",setup(p){const t=O(V),s=y(()=>{const a=t.data.first_responded_on&&C(t.data.first_responded_on).isBefore(t.data.response_by)?"Fulfilled":"Failed";if(t.data.priority==="Unclassified")return[{title:"Expected First Response",showSla:t.data.first_responded_on,label:a,theme:a==="Fulfilled"?"green":"red",value:t.data.response_by}];const m=t.data.resolution_date&&C(t.data.resolution_date).isBefore(t.data.resolution_by)?"Fulfilled":"Failed";return[{title:"Expected First Response",showSla:t.data.first_responded_on,label:a,theme:a==="Fulfilled"?"green":"red",value:t.data.response_by},{title:"Expected Resolution",showSla:t.data.resolution_date,label:m,theme:m==="Fulfilled"?"green":"red",value:t.data.resolution_by}]});function l(a){switch(a){case"Replied":return"Awaiting reply";default:return a}}return(a,m)=>{const _=I("Tooltip"),f=I("Badge");return o(),h("span",Pe,[n("div",Re,[Be,n("span",Ee,T(l(e(t).data.status)),1)]),n("div",Ie,[De,n("span",He,T(e(t).data.priority),1)]),(o(!0),h(D,null,H(s.value,i=>(o(),h("div",{key:i.label,class:"space-y-1.5"},[d(_,{text:e(C)(i.value).long()},{default:g(()=>[n("span",Ue,T(i.title),1)]),_:2},1032,["text"]),n("span",Ve,[i.showSla?(o(),k(f,{key:0,label:i.label,theme:i.theme,variant:"outline"},null,8,["label","theme"])):(o(),h("span",ze,T(e(C).tz(i.value).fromNow()),1))])]))),128)),(o(!0),h(D,null,H(e(t).data.template.fields.filter(i=>!i.hide_from_customer),i=>(o(),h("div",{key:i.fieldname,class:"space-y-1.5"},[n("span",Le,T(i.label),1),n("span",Ne,T(e(t).data[i.fieldname]),1)]))),128))])}}}),Me={class:"space-y-4 text-base text-gray-700"},je={class:"space-y-2"},Ae=n("span",null," Select a rating ",-1),qe=n("span",{class:"text-red-500"}," * ",-1),Je={key:0,class:"space-y-2"},We=n("span",null," Pick an option ",-1),Ge=n("span",{class:"text-red-500"}," * ",-1),Ke={class:"flex flex-wrap gap-2"},Qe={class:"space-y-2"},Xe=n("span",null," Other ",-1),Ye=E({__name:"TicketFeedback",props:{open:{type:Boolean}},emits:["update:open"],setup(p,{emit:t}){const s=t,l=O(V),a=S(0),m=S(""),_=S(null),f=ne({doctype:"HD Ticket Feedback Option",fields:["name","label"],pageLength:99999,onError:L()}),i=B({url:"frappe.client.set_value",debounce:300,makeParams:r=>({doctype:"HD Ticket",name:l.data.name,fieldname:r.fieldname,value:r.value}),onSuccess:()=>{s("update:open",!1),l.reload()},onError:L()});return W(a,r=>{_.value=null,m.value="",f.update({filters:{rating:r}}),f.reload()}),(r,u)=>{const c=I("Button"),F=I("FormControl"),w=I("Dialog");return o(),k(w,{"model-value":r.open,options:{title:"Rate this ticket",actions:[{disabled:!_.value,label:"Submit",theme:"gray",variant:"solid",onClick:()=>e(i).submit({fieldname:{status:"Closed",feedback:_.value,feedback_extra:m.value}})}]},"onUpdate:modelValue":u[2]||(u[2]=()=>r.$emit("update:open",!r.open))},{"body-content":g(()=>[n("div",Me,[n("div",je,[Ae,qe,d(e(de),{rating:a.value,"onUpdate:rating":u[0]||(u[0]=b=>a.value=b),static:!1},null,8,["rating"])]),e(f).data?.length?(o(),h("div",Je,[We,Ge,n("div",Ke,[(o(!0),h(D,null,H(e(f).data,b=>(o(),k(c,{key:b.name,label:b.label,theme:_.value===b.name?"blue":"gray",variant:"subtle",onClick:P=>_.value=b.name},null,8,["label","theme","onClick"]))),128))])])):R("",!0),n("div",Qe,[Xe,d(F,{modelValue:m.value,"onUpdate:modelValue":u[1]||(u[1]=b=>m.value=b),type:"textarea",placeholder:"Tell us more"},null,8,["modelValue"])])])]),_:1},8,["model-value","options"])}}}),Ze={key:0,class:"flex flex-col"},et={class:"m-5"},tt="Type a message",ht=E({__name:"TicketCustomer",props:{ticketId:{}},setup(p){const t=p,s=B({url:"helpdesk.helpdesk.doctype.hd_ticket.api.get_one",cache:["Ticket",t.ticketId],auto:!0,params:{name:t.ticketId}});oe(V,s);const l=S(null),a=S(""),m=S([]),_=S(!1),f=S(!1),i=B({url:"run_doc_method",debounce:300,makeParams:()=>({dt:"HD Ticket",dn:t.ticketId,method:"create_communication_via_contact",args:{message:a.value,attachments:m.value}}),onSuccess:()=>{l.value.editor.commands.clearContent(!0),m.value=[],f.value=!1,s.reload()}});function r(){b.value?_.value=!0:u.submit({fieldname:"status",value:"Closed"})}const u=B({url:"frappe.client.set_value",debounce:300,makeParams:P=>({doctype:"HD Ticket",name:t.ticketId,fieldname:P.fieldname,value:P.value}),onSuccess:()=>{_.value=!1,s.reload()},onError:L()}),c=y(()=>s.data.status==="Resolved"&&!s.data.feedback),F=y(()=>["Open","Replied"].includes(s.data.status)),w=y(()=>["Open","Replied","Resolved"].includes(s.data.status)),b=y(()=>s.data?.communications?.some(P=>{if(P.sender!==s.data.raised_by)return!0}));return(P,v)=>e(s).data?(o(),h("div",Ze,[d(le,{parent:"TicketsCustomer",current:"TicketCustomer"},{right:g(()=>[c.value?(o(),k(e(U),{key:0,label:"Reopen",theme:"gray",variant:"solid",onClick:v[0]||(v[0]=x=>e(u).submit({fieldname:"status",value:"Open"}))},{prefix:g(()=>[d(e($),{icon:"lucide:repeat-2"})]),_:1})):R("",!0),F.value?(o(),k(e(U),{key:1,label:"Close",theme:"gray",variant:"solid",onClick:v[1]||(v[1]=x=>r())},{prefix:g(()=>[d(e($),{icon:"lucide:check"})]),_:1})):R("",!0)]),_:1}),d(Oe),d(Fe,{class:"grow"}),n("span",et,[w.value?(o(),k(ie,{key:0,ref_key:"editor",ref:l,attachments:m.value,"onUpdate:attachments":v[3]||(v[3]=x=>m.value=x),content:a.value,"onUpdate:content":v[4]||(v[4]=x=>a.value=x),expand:f.value,"onUpdate:expand":v[5]||(v[5]=x=>f.value=x),placeholder:tt,autofocus:"",onClear:v[6]||(v[6]=()=>f.value=!1)},{"bottom-right":g(()=>[d(e(U),{label:"Send",theme:"gray",variant:"solid",disabled:P.$refs.editor.editor.isEmpty||e(i).loading,onClick:v[2]||(v[2]=()=>e(i).submit())},null,8,["disabled"])]),_:1},8,["attachments","content","expand"])):R("",!0)]),d(Ye,{open:_.value,"onUpdate:open":v[7]||(v[7]=x=>_.value=x)},null,8,["open"])])):R("",!0)}});export{ht as default};
//# sourceMappingURL=TicketCustomer-221584ef.js.map
